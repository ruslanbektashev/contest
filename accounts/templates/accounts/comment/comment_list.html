{% load views accounts comments markdown humanize static %}
{% render_comment_form obj %}
{% if page_obj.has_previous %}
<a class="btn btn-block btn-link mb-4" href="?page=1"><i class="fa fa-ellipsis-h fa-lg"></i></a>
{% endif %}
<div id="comments" class="comment-list">
    {% for comment in comments %}
    <div class="d-flex comment-list-item col{{ comment.level|add:'-13' }} offset-{{ comment.level|add:'-1' }} mb-3 p-3 rounded {% if comment not in request.user.account.comments_read.all %}bg-light{% endif %}">
        <a id="comment_{{ comment.id }}" class="comment-anchor">&nbsp</a>
        <div class="comment-avatar mr-3">
            <img src="{% static 'comment-avatar.png' %}">
        </div>
        <div class="comment-main">
            <div class="comment-header mb-1 d-flex lake">
                <div class="comment-user mr-2">
                    <a href="{{ comment.author.account.get_absolute_url }}" class="{% if comment.author.is_staff %}text-success{% endif %}">
                        {{ comment.author.account }}
                    </a>
                </div>
                <div class="text-muted">
                    ∙
                </div>
                <div class="comment-timesince text-muted ml-2">
                    <small class="comment-naturaltime">{{ comment.date_created|naturaltime }}</small>
                    <small class="comment-datetime"><a href="{{ comment.object.get_discussion_url }}{% get_comment_query_string page_obj.number %}#comment_{{ comment.id }}" class="text-muted">{{ comment.date_created|date:'d b Y г. в H:i' }}</a></small>
                </div>
            </div>
            <div class="d-block comment-text mb-1">
                {{ comment.text|markdown|safe }}
            </div>
            <div class="comment-footer lake">
                {% if comment.is_repliable %}
                <small><a href="{% url 'accounts:comment-reply' comment.id %}" class="text-uppercase text-muted">Ответить</a></small>
                {% endif %}
                {% if perms.accounts.change_comment or comment.author.id == request.user.id %}
                <small class="pebble">{% if comment.is_repliable %}| {% endif %}<a href="{% url 'accounts:comment-update' comment.id %}{% get_comment_query_string page_obj.number %}" class="text-uppercase text-muted">Редактировать</a></small>
                {% endif %}
                {% if perms.accounts.delete_comment %}
                <small class="pebble">| <a href="{% url 'accounts:comment-delete' comment.id %}{% get_comment_query_string page_obj.number %}" class="text-uppercase text-muted">Удалить</a></small>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% if page_obj.has_next %}
<a class="comment-list-more btn btn-block btn-link" href="?page={{ page_obj.next_page_number }}">еще</a>
{% endif %}

{% block javascript %}
    <script>
        let comments = document.getElementById('comments');
        let readCommentsIdsList = [];
        let helpWindow = document.getElementById('read_comments');

    if(parseInt('{% unread_comments_count request.user.account obj %}') > 0) {
        updateReadCommentsIdsList();
        window.addEventListener('scroll', updateReadCommentsIdsList, false);
        window.addEventListener('beforeunload', markCommentsAsRead, false);
    }

    function isInViewPoint(element) {
        let bounding = element.getBoundingClientRect();
        return (
            bounding.top >= 0 &&
            bounding.left >= 0 &&
            bounding.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
            bounding.right <= (window.innerWidth || document.documentElement.clientWidth)
        );
    }

    function updateReadCommentsIdsList() {
        for(let i = 0; i < comments.childElementCount; i++) {
            let commentId = parseInt(comments.children[i].getElementsByClassName('comment-anchor')[0].getAttribute('id').slice(8));
            let commentFooter = comments.children[i].getElementsByClassName('comment-main')[0].getElementsByClassName('comment-footer lake')[0];
            if(isInViewPoint(commentFooter) && !readCommentsIdsList.includes(commentId)) {
                readCommentsIdsList.push(commentId);
            }
        }
    }

    function markCommentsAsRead() {
        $.ajax({
            url: '{% url 'accounts:mark-comments-as-read' %}',
            type: 'POST',
            data: {
                'read_comments_ids_list[]': readCommentsIdsList,
                'object_model': '{{ obj|model_name }}',
                'object_id': '{{ obj.id }}',
            },
        });
    }
    </script>
{% endblock %}
