{% extends 'base_wide.html' %}
{% load views contests %}

{% block title %}
Профиль
{% endblock title %}

{% block breadcrumbs %}
{% breadcrumb "Главная" 'contests:index' %}
{% breadcrumb "Пользователи" 'accounts:account-list' %}
{% breadcrumb account %}
{% endblock breadcrumbs %}

{% block content %}
<legend>
    {{ account }}
    {% if account.user_id == request.user.id %}
    <a href="{% url 'password-change' %}" class="text-secondary text-decoration-none pull-right" data-toggle="tooltip" data-placement="top" title="Изменить пароль" style="position: relative; top: -0.03rem;"><i class="fa fa-lock fa-fw"></i></a>
    {% endif %}
    {% if perms.accounts.change_account or perms.auth.change_user_email or account.user_id == request.user.id %}
    <a href="{% url 'accounts:account-update' account.user.id %}" class="text-primary text-decoration-none pull-right" data-toggle="tooltip" data-placement="left" title="Редактировать профиль"><i class="fa fa-edit fa-fw"></i></a>
    {% endif %}
</legend>
<div class="row my-3">
    <div class="col-3">
        {% include 'accounts/account/account_card.html' with image=True %}
    </div>
    <div class="col-9">
        <table class="table table-borderless table-sm">
            <tr><td class="text-right" style="width: 30%;">e-mail</td><td>{% if account.email %}<a href="mailto:{{ account.email }}">{{ account.email }}</a>{% elif perms.auth.change_account or perms.auth.change_user_email or account.user_id == request.user.id %}<a href="{% url 'accounts:account-update' account.user_id %}" class="text-danger" >укажите e-mail</a>{% else %}-{% endif %}</td></tr>
            <tr><td class="text-right" style="width: 30%;">Факультет</td><td>{{ account.faculty }}</td></tr>
            <tr><td class="text-right" style="width: 30%;">Группа</td><td>{% for group in account.user.groups.all %} <span class="badge badge-secondary">{{ group }}</span>{% endfor %}</td></tr>
            <tr><td class="text-right" style="width: 30%;">Тип учетной записи</td><td>{{ account.get_type_display }}</td></tr>
            {% if account.is_student %}
            <tr><td class="text-right" style="width: 30%;">Уровень</td><td>{{ account.get_level_display }}</td></tr>
            <tr><td class="text-right" style="width: 30%;">Год поступления</td><td>{{ account.admission_year }}</td></tr>
            <tr><td class="text-right" style="width: 30%;">Обучается</td><td>{{ account.enrolled|yesno:'да,нет' }}</td></tr>
            <tr><td class="text-right" style="width: 30%;">Закончил обучение</td><td>{{ account.graduated|yesno:'да,нет' }}</td></tr>
            {% endif %}
            {% if perms.accounts.change_account %}
            <tr><td class="text-right" style="width: 30%;">Логин</td><td>{{ account.username }}</td></tr>
            <tr><td class="text-right" style="width: 30%;">Последний вход</td><td>{{ account.last_login|date:'d E Y, H:i' }}</td></tr>
            <tr><td class="text-right" style="width: 30%;">Дата регистрации</td><td>{{ account.date_joined|date:'d E Y' }}</td></tr>
            {% endif %}
        </table>
    </div>
</div>
{% if account.is_student %}
<a id="activity" class="activity-anchor">&nbsp</a>
<legend>Активность</legend>

<div class="row my-3">
    <div class="col-8">
        <div class="card mb-2">
            <div class="card-header d-flex align-items-center p-1">
                <span class="col-10 mr-auto">Учебный год</span>
                <select id="year_select" name="year" class="col-2 form-control selectpicker" onchange="document.location=this.options[this.selectedIndex].value;" style="width:20%;">
                    {% for yr, yr_display in years %}
                    <option value="{% get_full_path_with_updated_query_string request year=yr %}#activity" {% if year == yr %}selected{% endif %}>{{ yr_display }}</option>
                    {% endfor %}
                </select>
                <label for="year_select"></label>
            </div>
            <div class="card-body">
                <canvas id="submissionsChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4 d-flex align-items-stretch">
        <div class="card mb-2">
            <div class="card-header">
                Все время
            </div>
            <div class="card-body">
                <canvas id="activityOverviewChart"></canvas>
            </div>
        </div>
    </div>
</div>

{% if perms.contests.view_assignment_table or account.user_id == request.user.id %}
{% if credits %}
<legend>
    Результаты
    {% if account.is_student %}
    {% if perms.accounts.change_account or perms.auth.change_user_email or account.user_id == request.user.id %}
    <a href="{% if account.user_id == request.user.id %} {% url 'contests:assignment-list' %} {% else %} {% url 'accounts:account-assignment-list' account.user_id %} {% endif %}" class="text-secondary text-decoration-none pull-right" data-toggle="tooltip" data-placement="left" title="Задания" style="position: relative; top: -0.08rem;"><i class="fa fa-list-ol fa-fw"></i></a>
    {% endif %}
    {% endif %}
</legend>
{% include 'accounts/account/account_results.html' %}
<div class="table-responsive mb-3">
    <table class="table table-sm table-borderless">
        <tbody>
            {% if account.submissions_score %}
            <tr>
                <td style="vertical-align: middle;">Точность</td>
                <td class="text-center" style="vertical-align: middle; width: 70%;">
                    {% render_progress account.submissions_score "" %}
                </td>
                <td class="text-center" style="vertical-align: middle; width: 4%;">
                    <span class="d-inline-block" data-toggle="popover" data-placement="left" data-trigger="hover" data-content="Учитывает количество посылок для решения задачи">
                        <i class="text-muted fa fa-question-circle fa-fw" style="position: relative; top: -0.08rem;"></i>
                    </span>
                </td>
            </tr>
            {% endif %}
            {% if account.score %}
            <tr>
                <td style="vertical-align: middle;">Общая успеваемость</td>
                <td class="text-center" style="vertical-align: middle; width: 70%;">
                    {% render_progress account.score "" %}
                </td>
                <td class="text-center" style="vertical-align: middle; width: 4%;">
                    <span class="d-inline-block" data-toggle="popover" data-placement="left" data-trigger="hover" data-content="Учитывает оценки по курсам и количество посылок для решения задачи">
                        <i class="text-muted fa fa-question-circle fa-fw" style="position: relative; top: -0.08rem;"></i>
                    </span>
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endif %}
{% endif %}
{% endif %}
{% endblock content %}

{% block javascript %}
<script>
    const submissionsChartData = {
        labels: [{% for item in month_submissions_solutions_comments %} '{{ item.0 }}', {% endfor %}],
        datasets: [{
            label: 'Посылки',
            backgroundColor: 'rgb(0, 123, 255)',
            borderColor: 'rgb(0, 123, 255)',
            data: [{% for item in month_submissions_solutions_comments %} {{ item.1 }}, {% endfor %}],
        }, {
            label: 'Решения',
            backgroundColor: 'rgb(40, 167, 69)',
            borderColor: 'rgb(40, 167, 69)',
            data: [{% for item in month_submissions_solutions_comments %} {{ item.2 }}, {% endfor %}],
        }, {
            label: 'Комментарии',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: [{% for item in month_submissions_solutions_comments %} {{ item.3 }}, {% endfor %}],
        }]
    };

    const submissionsChartConfig = {
        type: 'bar',
        data: submissionsChartData,
        options: {
            scales: {
                y: {
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    };

    var submissionsChart = new Chart(
        document.getElementById('submissionsChart'),
        submissionsChartConfig
    );

    const activityOverviewChartData = {
        labels: [
            'Комментарии',
            'Вопросы',
            'Сообщения об ошибках',
            'Решения',
        ],
        datasets: [{
            data: [
                {{ comments_count }},
                {{ questions_count }},
                {{ reports_count }},
                {{ account.solved_problems_count }},
            ],
            fill: true,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgb(54, 162, 235)',
            pointBackgroundColor: 'rgb(54, 162, 235)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgb(54, 162, 235)'
        }]
    };

    const activityOverviewChartConfig = {
        type: 'radar',
        data: activityOverviewChartData,
        options: {
            elements: {
                line: {
                    borderWidth: 3
                }
            },
            plugins: {
                legend: {
                    display: false,
                }
            }
        },
    };

    var activityOverviewChart = new Chart(
        document.getElementById('activityOverviewChart'),
        activityOverviewChartConfig
    );
</script>
{% endblock javascript %}
