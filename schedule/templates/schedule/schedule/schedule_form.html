{% extends 'base_wide.html' %}
{% load views forms static %}

{% block title %}
Расписание
{% endblock title %}

{% block stylesheets %}
<link href="{% static 'tempus-dominus/css/tempus-dominus.css' %}" rel="stylesheet">
<link href="{% static 'tempus-dominus/css/tempus-dominus.patch.css' %}" rel="stylesheet">
{% endblock stylesheets %}

{% block breadcrumbs %}
{% breadcrumb "Главная" 'contests:index' %}
{% breadcrumb "Расписание" 'schedule:schedule-list' %}
{% if schedule %}
{% breadcrumb schedule schedule %}
{% breadcrumb "Редактирование" %}
{% else %}
{% breadcrumb "Новое расписание" %}
{% endif %}
{% endblock breadcrumbs %}

{% block content %}
<legend>{% if schedule %}Редактирование{% else %}Добавление{% endif %} расписания</legend>
<form action="" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {% render_form_errors form %}
    <div class="form-group">
        <label for="id_date_interval">В интервале</label>
        <input type="text" class="form-control {% if form.date_from.errors %}is-invalid{% endif %}" id="id_date_interval"/>
        {% if form.date_from.errors %}
        <div class="invalid-feedback">
            {% for error in form.date_from.errors %}{{ error }}{% endfor %}
        </div>
        {% endif %}
    </div>
    {{ form.date_from.as_hidden }}
    {{ form.date_to.as_hidden }}
    {{ attachment_formset.management_form }}
    {% if attachment_formset.non_form_errors %}
    <div class="form-group">
        <div class="alert alert-danger">
            {% for error in attachment_formset.non_form_errors %}
            {{ error }}<br>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% for form in attachment_formset %}
    <div class="form-row">
        <div class="form-group col-md-4 col-sm-12">
        {% with field=form.name %}
            <div class="input-group">
                {% with is_invalid=field.errors|yesno:"is-invalid," %}
                {% render_field field class+="form-control" placeholder=field.label class+=is_invalid %}
                {% endwith %}
                {% if field.field.append_text %}
                <div class="input-group-append">
                    <span class="input-group-text">{{ field.field.append_text }}</span>
                </div>
                {% endif %}
                {% if field.errors %}
                <div class="invalid-feedback">
                    {% for error in field.errors %}{{ error }}{% endfor %}
                </div>
                {% endif %}
            </div>
            {% if field.help_text %}
            <small class="form-text text-muted">{{ field.help_text }}</small>
            {% endif %}
        {% endwith %}
        </div>
        <div class="form-group col-md-8 col-sm-12">
        {% with field=form.file %}
            <div class="input-group {% if field.errors %}is-invalid{% endif %}">
                <div class="custom-file">
                    {% with is_invalid=field.errors|yesno:"is-invalid," %}
                    {% render_field field class+="custom-file-input" class+=is_invalid %}
                    {% endwith %}
                    <label class="custom-file-label" for="{{ field.id_for_label }}">Выберите файл с расширением .htm или .pdf</label>
                </div>
            </div>
            {% if field.errors %}
            <div class="invalid-feedback">
                {% for error in field.errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}
        {% endwith %}
        </div>
    </div>
    {% endfor %}
    {% render_submit_button value="Сохранить" %}
</form>
{% endblock content %}

{% block javascript %}
<script src="{% static 'js/bs-custom-file-input.min.js' %}" type="text/javascript"></script>
<script src="{% static 'moment/min/moment.min.js' %}" type="text/javascript"></script>
<script src="{% static 'moment/min/locales.min.js' %}" type="text/javascript"></script>
<script src="{% static 'popper/popper.min.js' %}" type="text/javascript"></script>
<script src="{% static 'tempus-dominus/js/tempus-dominus.js' %}" type="text/javascript"></script>
<script src="{% static 'tempus-dominus/tempus-dominus.options.js' %}" type="text/javascript"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
    let date_interval_field = document.getElementById('id_date_interval');
    let date_from_field = document.getElementById('id_date_from');
    let date_to_field = document.getElementById('id_date_to');

    tdOptions.display.components.clock = false;
    const picker = new tempusDominus.TempusDominus(date_interval_field, tdOptions);

    moment.updateLocale('ru', { week: { dow: 1 } });
    date_interval_field.addEventListener('change', function () {
        let chosen_date = date_interval_field.value;
        if (chosen_date) {
            let new_date_from = moment(chosen_date, "DD.MM.YYYY").day(1);
            let new_date_to =  moment(chosen_date, "DD.MM.YYYY").day(7);
            date_from_field.value = new_date_from.format("YYYY-MM-DD");
            date_to_field.value = new_date_to.format("YYYY-MM-DD");
            date_interval_field.value = new_date_from.format("DD.MM.YYYY") + " - " + new_date_to.format("DD.MM.YYYY");
        } else {
            let cur_date_from = moment(date_from_field.value, "YYYY-MM-DD").format("DD.MM.YYYY");
            let cur_date_to = moment(date_to_field.value, "YYYY-MM-DD").format("DD.MM.YYYY");
            date_interval_field.value = cur_date_from + " - " + cur_date_to;
        }
    });
    bsCustomFileInput.init();
});
</script>
{% endblock javascript %}
