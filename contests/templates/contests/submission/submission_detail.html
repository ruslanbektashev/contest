{% extends 'base_wide.html' %}
{% load views forms accounts contests comments static %}

{% block title %}
Посылка
{% endblock title %}

{% block breadcrumbs %}
{% breadcrumb "Главная" 'contests:index' %}
{% if from_assignment and submission.get_assignment %}
{% if perms.contests.view_assignment_table %}
{% breadcrumb submission.problem.contest.course submission.problem.contest.course %}
{% breadcrumb "Задания" 'contests:assignment-table' submission.problem.contest.course_id %}
{% else %}
{% breadcrumb "Мои задания" 'contests:assignment-list' %}
{% endif %}
{% breadcrumb submission.get_assignment submission.get_assignment %}
{% if submission.main_submission %}
{% breadcrumb submission.main_submission.short_title submission.main_submission query_string='?from_assignment=1' %}
{% endif %}
{% else %}
{% breadcrumb submission.problem.contest.course submission.problem.contest.course %}
{% breadcrumb submission.problem.contest submission.problem.contest %}
{% breadcrumb submission.problem submission.problem %}
{% if submission.main_submission %}
{% breadcrumb submission.main_submission.short_title submission.main_submission %}
{% endif %}
{% endif %}
{% breadcrumb submission.short_title %}
{% endblock breadcrumbs %}

{% block content %}
<legend>
    {{ submission.short_title }}
    <span class="pull-right">
    {% if perms.contests.moss_submission and submission.problem.type == 'Program' %}
        <a href="{% url 'contests:submission-moss' submission.id %}" class="text-secondary text-decoration-none" data-toggle="tooltip" data-placement="left" title="MOSS"><i class="fa fa-maxcdn fa-fw"></i></a>
    {% endif %}
    {% if perms.contests.delete_submission %}
        <a href="{% url 'contests:submission-delete' submission.id %}{% if from_assignment %}?from_assignment=1{% endif %}" class="text-danger text-decoration-none" data-toggle="tooltip" data-placement="top" title="Удалить посылку" style="position: relative; top: -0.08rem;"><i class="fa fa-times fa-fw"></i></a>
    {% endif %}
    </span>
</legend>
<table class="table table-sm">
    <tr><td class="text-right" style="width: 20%;">Автор</td><td><a href="{{ submission.owner.account.get_absolute_url }}">{{ submission.owner.account }}</a></td></tr>
    <tr><td class="text-right" style="width: 20%;">К задаче</td><td><a href="{{ submission.problem.get_absolute_url }}">{{ submission.problem }}</a></td></tr>
    {% if submission.get_assignment %}
    <tr><td class="text-right" style="width: 20%;">По заданию</td><td><a href="{{ submission.get_assignment.get_absolute_url }}"><span class="numtus status-{{ submission.get_assignment.score|colorize }}">{{ submission.get_assignment.score|default:'-' }}</span></a></td></tr>
    {% endif %}
    <tr><td class="text-right" style="width: 20%;">Отправлена</td><td>{{ submission.date_created }}</td></tr>
    {% if submission.date_updated %}
    <tr><td class="text-right" style="width: 20%;">Проверена</td><td>{{ submission.date_updated }}</td></tr>
    {% endif %}
    {% if submission.problem.type == 'Test' %}
    <tr><td class="text-right" style="width: 20%;">Решено подзадач</td><td>{{ submission.sub_submissions.count }} из {{ submission.problem.sub_problems.count }}</td></tr>
    {% endif %}
    {% if submission.main_submission %}
    <tr><td class="text-right" style="width: 20%;">Основная посылка</td><td><a href="{{ submission.main_submission.get_absolute_url }}{% if from_assignment %}?from_assignment=1{% endif %}"><span class="numtus status-{{ submission.main_submission.status|colorize }}">{{ submission.main_submission.status }}</span></a></td></tr>
    {% endif %}
</table>
<div class="progress justify-content-center mb-3" style="height: 25px;">
    <div id="progress-bar" class="progress-bar bg-{% get_submission_style submission %}" role="progressbar" aria-valuenow="{% if submission.task_id %}0{% elif submission.problem.type != 'Program' and score_percentage > 0 %}{{ score_percentage }}{% else %}100{% endif %}" aria-valuemin="0" aria-valuemax="100" style="width: {% if submission.task_id %}0{% elif submission.problem.type != 'Program' and score_percentage > 0 %}{{ score_percentage }}{% else %}100{% endif %}%;"></div>
    <span class="status-display align-self-center" style="position: absolute;">
        <strong id="progress-bar-message" style="color: white;">
            {{ submission.get_status_display }} {% if submission.problem.type != 'Program' and score_percentage > 0 %} · {{ score_percentage }}% {% endif %}
        </strong>
    </span>
</div>
{% if not submission.problem.type == 'Program' or not submission.problem.is_testable %}
{% if perms.contests.change_submission %}
<button type="button" id="submission-update-toggle-0" class="btn btn-light btn-block border mb-3" data-toggle="button" aria-pressed="{% if form.errors|length == 0 %}false{% else %}true{% endif %}">Изменить оценку</button>
<form {% if form.errors|length == 0 %}hidden{% endif %} action="" id="submission-update-form-0" method="post" class="form-horizontal card">
    <div class="card-body">
        {% csrf_token %}
        {% render_form_errors form %}
        {% with WIDGET_RENDER_TO_TEMPLATE="field.html" WIDGET_ERROR_CLASS="is-invalid" %}
        {% render_field form.status class+="form-control selectpicker" %}
        {% render_field form.score class+="form-control" %}
        {% endwith %}
        <button class="btn btn-light btn-block border">Сохранить</button>
    </div>
</form>
{% endif %}
{% elif submission.is_un %}
<a href="{% url 'contests:submission-evaluate' submission.id %}{% if from_assignment %}?from_assignment=1{% endif %}" class="btn btn-light btn-block border mb-3">Проверить</a>
{% elif perms.contests.evaluate_submission %}
<a href="{% url 'contests:submission-evaluate' submission.id %}{% if from_assignment %}?from_assignment=1{% endif %}" class="btn btn-light btn-block border mb-3">Проверить еще раз</a>
{% endif %}
{% if submission.problem.type == 'Test' and submission.owner.id == request.user.id and submission.sub_submissions.all|length < submission.problem.sub_problems.all|length %}
    {% if submission.assignment is None or submission.assignment.deadline and submission.assignment.deadline > current_time %}
        <a href="{% url 'contests:sub-submission-create' submission.problem.id submission.id %}" class="btn btn-light btn-block border mb-3">Продолжить решать</a>
    {% endif %}
{% endif %}
<div class="accordion mb-3" id="execution_list">
    {% render_execution_list submission.execution_set.all %}
</div>
{% if submission.problem.type == 'Program' or submission.problem.type == 'Files' %}
<div class="text-right text-muted">
    {% if perms.contests.download_submission %}
    <p class="text-warning text-break">
        <span data-toggle="tooltip" data-placement="left" title="Отображается только преподавателям">
            <i class="fa fa-lock fa-fw"></i>директория на сервере: {{ submission.attachment_set.all.0.dirname }}
        </span>
    </p>
    {% endif %}
    {% if perms.contests.moss_submission %}
        {% if submission.moss_to_submissions %}
    <p class="text-warning text-wrap" data-toggle="tooltip" data-placement="left" title="Отображается только преподавателям"><i class="fa fa-lock fa-fw"></i>с посылками MOSS: {% for to_submission_id in submission.moss_to_submissions_list %}<a href="{% url 'contests:submission-detail' to_submission_id %}">{{ to_submission_id }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}</p>
    <p class="text-warning text-wrap" data-toggle="tooltip" data-placement="left" title="Отображается только преподавателям"><i class="fa fa-lock fa-fw"></i>ссылка на отчет MOSS: {% if submission.moss_report_url %}<a href="{{ submission.moss_report_url }}" target="_blank">{{ submission.moss_report_url }}</a>{% else %}ожидание ответа...{% endif %}</p>
        {% endif %}
    {% endif %}
</div>
<legend>
    Файлы
    <span class="pull-right">
    {% if perms.contests.download_submission %}
        <a href="{% url 'contests:submission-download' submission.id %}" data-toggle="tooltip" data-placement="left" title="Скачать все файлы"><i class="fa fa-download fa-fw"></i></a>
    {% endif %}
    </span>
</legend>
<div class="list-group mb-3">
    {% for attachment in submission.attachment_set.all %}
    <span class="list-group-item d-flex">
        {% if perms.contests.download_submission %}
        <a class="mr-auto" href="{% url 'contests:submission-attachment' submission.id attachment.id %}{% if from_assignment %}?from_assignment=1{% endif %}"><samp>{{ attachment.filename }}</samp></a>
        <a href="{{ attachment.file.url }}" data-toggle="tooltip" data-placement="left" title="Скачать"><i class="fa fa-download fa-fw"></i></a>
        {% else %}
        <samp>{{ attachment.filename }}</samp>
        {% endif %}
    </span>
    {% endfor %}
</div>
{% endif %}
{% if submission.problem.type == 'Text' %}
<h6 class="text-muted">Ответ:</h6>
<div class="card mb-3">
    <div class="card-body">
        {{ submission.text|safe }}
    </div>
</div>
{% if perms.contests.change_submission and submission.footprint %}
<div class="text-right">
<span data-toggle="tooltip" data-placement="left" title="Отображается только преподавателям">
    <i class="fa fa-lock fa-fw"></i>
{% if submission.has_footprint_increments %}
    <span class="text-warning">
        Обнаружена вставка текста.
    </span>
{% else %}
    <span class="text-success">
        Вставка текста не обнаружена.
    </span>
{% endif %}
    <button class="btn btn-link px-0" onclick="toggleText(this, 'Показать график', 'Скрыть график')" data-toggle="collapse" data-target="#collapseChart" aria-expanded="false" aria-controls="collapseChart">
        Показать график
    </button>
</span>
</div>
<div class="card mb-3 collapse" id="collapseChart">
    <div class="card-body">
        <canvas id="footprintChart" height="120"></canvas>
    </div>
</div>
{% endif %}
{% endif %}
{% if submission.problem.type == 'Options' %}
<h6 class="text-muted">Ответ:</h6>
<ul class="list-group mb-3">
    {% for option in submission.problem.option_set.all %}
    <li class="list-group-item {% if option in submission.options.all %}{% if option.is_correct %}text-success{% else %}text-danger{% endif %}{% endif %}">
        {% if option in submission.options.all %}{% if option.is_correct %}<i class="fa fa-check-circle-o" aria-hidden="true"></i>{% else %}<i class="fa fa-times-circle-o" aria-hidden="true"></i>{% endif %}{% endif %} {{ option.text }}
    </li>
    {% endfor %}
</ul>
{% endif %}
{% if submission.problem.type == 'Test' %}
<h6 class="text-muted">Подпосылки:</h6>
{% for sub_form in forms %}

<div class="card mb-3">
    <div class="card-header d-flex align-items-center">
        <small class="mr-3" data-toggle="tooltip" data-placement="top" title="Номер подзадачи">{{ sub_form.instance.problem.number }}</small>
        {% if sub_form.instance.problem.title %}
        <small class="mr-auto">
            <a href="{% url 'contests:problem-detail' sub_form.instance.problem.id %}" class="card-link">
                {{ sub_form.instance.problem.title }}
            </a>
        </small>
        {% endif %}
        {% if perms.contests.change_submission and sub_form.instance.problem.type == 'Text' %}
        {% if sub_form.instance.has_footprint_increments %}
        <span class="text-warning mr-2" data-toggle="tooltip" data-placement="top" title="Обнаружена вставка текста" style="position: relative; top: -0.08em;"><i class="fa fa-exclamation-triangle fa-fw fa-lg"></i></span>
        {% else %}
        <span class="text-success mr-2" data-toggle="tooltip" data-placement="top" title="Вставка текста не обнаружена" style="position: relative; top: -0.08em;"><i class="fa fa-check-circle fa-fw fa-lg"></i></span>
        {% endif %}
        {% endif %}
        <small>{{ sub_form.instance.problem.get_type_display }}</small>
        {% if perms.contests.change_submission %}
        <a id="submission-update-toggle-{{ forloop.counter }}" class="card-link ml-3" data-toggle="tooltip" data-placement="top" title="Изменить оценку">
            <i class="fa fa-edit fa-fw fa-lg"></i>
        </a>
        {% endif %}
        <a href="{{ sub_form.instance.get_absolute_url }}{% if from_assignment %}?from_assignment=1{% endif %}" class="status status-{{ sub_form.instance.status|colorize }} ml-3" data-toggle="tooltip" data-placement="top" title="{{ sub_form.instance.get_status_display }}">
            {{ sub_form.instance.status }}
        </a>
    </div>
    {% if perms.contests.change_submission %}
    <form {% if sub_form.errors|length == 0 %}hidden{% endif %} action="" id="submission-update-form-{{ forloop.counter }}" method="post" class="form-horizontal card-header">
        {% csrf_token %}
        {% render_form_errors sub_form %}
        {% with WIDGET_RENDER_TO_TEMPLATE="field.html" WIDGET_ERROR_CLASS="is-invalid" %}
        {% render_field sub_form.status class+="form-control selectpicker" %}
        {% render_field sub_form.score class+="form-control" %}
        {% endwith %}
        <button class="btn btn-light btn-block border mb-2" name="sub_submission_id" value="{{ sub_form.instance.id }}">Сохранить</button>
    </form>
    {% endif %}
    <div class="card-body bg-light">
        {{ sub_form.instance.problem.description|safe }}
        <h6 class="text-muted">Ответ:</h6>
        {% if sub_form.instance.problem.type == 'Program' or sub_form.instance.problem.type == 'Files' %}
        <div class="text-right text-muted">
            {% if perms.contests.moss_submission %}
                {% if sub_form.instance.moss_to_submissions %}
            <p class="text-warning text-wrap" data-toggle="tooltip" data-placement="left" title="Отображается только преподавателям"><i class="fa fa-lock fa-fw"></i>с посылками MOSS: {% for to_submission_id in sub_form.instance.moss_to_submissions_list %}<a href="{% url 'contests:submission-detail' to_submission_id %}">{{ to_submission_id }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}</p>
            <p class="text-warning text-wrap" data-toggle="tooltip" data-placement="left" title="Отображается только преподавателям"><i class="fa fa-lock fa-fw"></i>ссылка на отчет MOSS: {% if sub_form.instance.moss_report_url %}<a href="{{ sub_form.instance.moss_report_url }}" target="_blank">{{ sub_form.instance.moss_report_url }}</a>{% else %}ожидание ответа...{% endif %}</p>
                {% endif %}
            {% endif %}
        </div>
        <legend>Файлы {% if perms.contests.download_submission %}<a href="{% url 'contests:submission-download' sub_form.instance.id %}" data-toggle="tooltip" data-placement="left" title="Скачать все файлы"><i class="fa fa-download fa-fw"></i></a>{% endif %}</legend>
        <div class="list-group">
            {% for attachment in sub_form.instance.attachment_set.all %}
            <span class="list-group-item d-flex">
                {% if perms.contests.download_submission %}
                <a class="mr-auto" href="{% url 'contests:submission-attachment' sub_form.instance.id attachment.id %}"><samp>{{ attachment.filename }}</samp></a>
                <a href="{{ attachment.file.url }}" data-toggle="tooltip" data-placement="left" title="Скачать"><i class="fa fa-download fa-fw"></i></a>
                {% else %}
                <samp>{{ attachment.filename }}</samp>
                {% endif %}
            </span>
            {% endfor %}
        </div>
        {% endif %}
        {% if sub_form.instance.problem.type == 'Text' %}
        <div class="card">
            <div class="card-body">
                {{ sub_form.instance.text|safe }}
            </div>
        </div>
        {% endif %}
        {% if sub_form.instance.problem.type == 'Options' %}
        <ul class="list-group mb-3">
            {% for option in sub_form.instance.problem.option_set.all %}
            <li class="list-group-item {% if option in sub_form.instance.options.all %}{% if option.is_correct %}text-success{% else %}text-danger{% endif %}{% endif %}">
                {% if option in sub_form.instance.options.all %}{% if option.is_correct %}<i class="fa fa-check-circle-o" aria-hidden="true"></i>{% else %}<i class="fa fa-times-circle-o" aria-hidden="true"></i>{% endif %}{% endif %} {{ option.text }}
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
</div>
{% endfor %}
{% endif %}
<legend>Комментарии</legend>
{% render_comments submission comments %}
{% endblock content %}

{% block javascript %}
<script src="{% static 'js/submissions.js' %}" type="text/javascript"></script>
<script src="{% static 'js/utils.js' %}" type="text/javascript"></script>
<script src="{% static 'waypoints/lib/jquery.waypoints.min.js' %}" type="text/javascript"></script>
<script src="{% static 'waypoints/lib/shortcuts/infinite.min.js' %}" type="text/javascript"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    let elements = document.querySelectorAll('.execution-collapse-toggle');
    for (let elem of elements) {
        elem.addEventListener("click", function () {
            elem.firstChild.classList.toggle("fa-angle-up");
            elem.firstChild.classList.toggle("fa-angle-down");
            //toggleHTML(elem, '<i class="fa fa-angle-down fa-lg"></i>', '<i class="fa fa-angle-up fa-lg"></i>');
        });
    }
});
</script>
<script>
var infinite = new Waypoint.Infinite({
    element: $('.comment-list')[0],
    items: '.comment-list-item',
    more: '.comment-list-more'
});
</script>
<script type="text/javascript">
{% if submission.task_id %}
$(function () {
    let bar = new TaskProgress("{% url 'contests:submission-get-progress' submission.task_id %}", "{% url 'contests:submission-get-executions' submission.id %}");
    bar.poll();
});
{% endif %}
</script>
{% if submission.problem.type != 'Program' and score_percentage > 0 %}
<script>
progress_bar_message_element = document.getElementById('progress-bar-message');
if ({{ score_percentage }} <= 40 && progress_bar_message_element.style.color === 'white') {
    progress_bar_message_element.style.color = 'black';
} else if ({{ score_percentage }} > 40 && progress_bar_message_element.style.color === 'black') {
    progress_bar_message_element.style.color = 'white';
}
</script>
{% endif %}
{% if submission.problem.type == 'Text' and perms.contests.change_submission %}
<script>

const interval = 10;

let footprint = JSON.parse("{{ submission.footprint }}");
let labels = Array(footprint.length)

for (let i = 0; i < labels.length; i++) {
    labels[i] = i * interval;
}

const footprintData = {
    labels: labels,
    datasets: [
        {
            label: 'Длина текста',
            data: footprint,
            borderColor: 'rgb(91, 192, 222)',
            backgroundColor: 'rgb(91, 192, 222)',
        },
    ],
};

const footprintChartConfig = {
    type: 'line',
    data: footprintData,
    options: {
        interaction: {
            intersect: false
        },
        radius: 0,
        responsive: true,
        plugins: {
            legend: {
                display: false,
            },
        },
        scales: {
            x: {
                ticks: {
                    stepSize: 1,
                },
                title: {
                    display: true,
                    text: 'Секунды'
                },
            },
            y: {
                title: {
                    display: true,
                    text: 'Количество символов'
                },
                ticks: {
                    stepSize: 1,
                }
            },
        },
    },
};

var footprintChart = new Chart(
    document.getElementById('footprintChart'),
    footprintChartConfig
);

</script>
{% endif %}
{% if perms.contests.change_submission %}
<script>
for (let i = 0; i <= {% if forms %}{{ forms|length }}{% else %}0{% endif %}; i++) {
    let submissionUpdateForm = document.getElementById('submission-update-form-' + i);
    let submissionUpdateButton = document.getElementById('submission-update-toggle-' + i);
    submissionUpdateButton.addEventListener('click', function() {
        submissionUpdateForm.hidden = !submissionUpdateForm.hidden;
    });
}
</script>
{% endif %}
{% endblock javascript %}
