{% extends 'base_wide.html' %}
{% load views forms static %}

{% block title %}
Посылка
{% endblock title %}

{% block breadcrumbs %}
{% breadcrumb "Главная" 'contests:index' %}
{% if from_assignment and assignment %}
{% if perms.contests.view_assignment_table %}
{% breadcrumb problem.course problem.course %}
{% breadcrumb "Задания" 'contests:assignment-table' problem.course.id %}
{% else %}
{% breadcrumb "Мои задания" 'contests:assignment-list' %}
{% endif %}
{% breadcrumb assignment assignment %}
{% if main_submission %}
{% breadcrumb main_submission.short_title main_submission query_string='?from_assignment=1' %}
{% endif %}
{% else %}
{% breadcrumb problem.course problem.course %}
{% breadcrumb problem.contest problem.contest %}
{% breadcrumb problem problem %}
{% if main_submission %}
{% breadcrumb main_submission.short_title main_submission %}
{% endif %}
{% endif %}
{% breadcrumb "Новая посылка" %}
{% endblock breadcrumbs %}

{% block content %}
<legend>
    Отправить решение
    {% if main_problem and assignment.deadline is not None and assignment.deadline > current_time %}
    <span id="countdown_wrapper" class="text-muted pull-right">осталось: <span id="countdown_to_deadline"></span></span>
    {% endif %}
</legend>

{% if problem.type == 'Text' or problem.type == 'Options' or problem.type == 'Files' %}
<p>{{ problem.description|safe }}</p>
{% endif %}

<form action="" id="submission-form" method="post" enctype="multipart/form-data" class="form-horizontal">
    {% csrf_token %}
    {% render_form_errors form %}
    {% if problem.type == 'Program' %}
    <div class="alert alert-warning" role="alert">
        Решения компилируются средствами gcc под операционной системой семейства Linux.<br>
        Некоторые ошибки компиляции могут быть связаны с различием компиляторов.<br>
        Принимаются файлы только с кодировкой UTF-8.<br>
    </div>
    {% endif %}
    {% if problem.submission_patterns.exists %}
    <div class="alert alert-info" role="contentinfo">
        {% for submission_pattern in problem.submission_patterns.all %}
        {{ submission_pattern.description|safe|linebreaksbr }}
        {% endfor %}
    </div>
    {% endif %}
    {% if problem.type == 'Files' %}
    <div class="alert alert-info" role="alert">
        Прикрепите файл(ы) в качестве ответа.
    </div>
    {% endif %}

    {% if problem.type == 'Program' or problem.type == 'Files' %}
    {% with WIDGET_RENDER_TO_TEMPLATE="field_file.html" WIDGET_ERROR_CLASS="is-invalid" %}
    {% render_field form.files class+="custom-file-input"%}
    {% endwith %}
    {% endif %}

    {% if problem.type == 'Text' %}

    {{ form.media }}
    <div class="form-group">
        <label for="{{ field.id_for_label }}">
            {{ form.text.label }}{{ form.text.label_suffix }}
        </label>
        {% if form.text.errors %}
        <div class="form-group">
            <div class="alert alert-danger">
                {% for error in form.text.errors %}
                {{ error }}<br>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        <div class="input-group">
            {{ form.text }}
            {{ form.footprint }}
        </div>
    </div>

    {% elif problem.type == 'Options' %}

    {{ form.options }}

    {% endif %}
    {% if problem.type == 'Text' %}
    <div class="form-group">
        <button id="form_proceed" class="btn btn-light btn-block border" type="button" onclick="showConfirmation()" style="opacity: 1;">Продолжить</button>
    </div>
    <div class="form-group">
        <div id="form_confirm" class="btn-group btn-block" hidden style="opacity: 0;">
            <input class="btn btn-info col-11" type="submit" value="Отправить" />
            <button class="btn btn-danger" type="button" onclick="hideConfirmation()">Отмена</button>
        </div>
    </div>
    {% else %}
    <div class="form-group">
        <input class="btn btn-light btn-block border" type="submit" value="Отправить"/>
    </div>
    {% endif %}
</form>

{% if pending_sub_problems %}
<h6 class="text-muted">Вы можете перейти к решению других задач этого теста. Неотправленное решение текущей задачи будет утеряно!</h6>
<div class="list-group mb-0">
    {% for sub_problem in pending_sub_problems %}
    <a href="{% if main_submission %}{% url 'contests:sub-submission-create' main_problem.id main_submission.id %}{% else %}{% url 'contests:submission-create' main_problem.id %}{% endif %}?sub_problem={{ sub_problem.id }}{% if from_assignment %}&from_assignment=1{% endif %}" class="list-group-item list-group-item-action d-flex" title="{{ sub_problem.get_type_display }}">
        {{ sub_problem }}
    </a>
    {% endfor %}
</div>
{% endif %}

{% endblock content %}

{% block javascript %}
{% if problem.type == 'Program' or problem.type == 'Files' %}
<script src="{% static 'js/bs-custom-file-input.min.js' %}" type="text/javascript"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
    bsCustomFileInput.init()
});
</script>
{% endif %}
{% if problem.type == 'Text' %}
<script type="text/javascript">
const second = 1000;
const interval = 10 * second;
let measurements = [];

function measureTextLength() {
    let text = CKEDITOR.instances['id_text'].document.getBody().getText();
    measurements.push(text.length);
    document.getElementById("id_footprint").value = JSON.stringify(measurements);
    console.log(text.length);
    return true
}

function watchText() {
    setInterval(measureTextLength, interval);
    measureTextLength();
    document.getElementById('submission-form').addEventListener('submit', measureTextLength);
}

document.addEventListener("DOMContentLoaded", function() {
    let checkExist = setInterval(function() {
        if (CKEDITOR.instances['id_text'].document !== undefined) {
            watchText();
            clearInterval(checkExist);
        }
    }, 100);
});
</script>
<script src="{% static 'js/utils.js' %}" type="text/javascript"></script>
<script type="text/javascript">
function showConfirmation() {
    let proceed_element = document.getElementById('form_proceed');
    let confirm_element = document.getElementById('form_confirm');
    //proceed_button.classList.toggle('d-none');
    //confirm_button.classList.toggle('d-none');
    toggleOpacity(proceed_element, confirm_element, '0.3s', '0.7s');
}

function hideConfirmation() {
    let proceed_element = document.getElementById('form_proceed');
    let confirm_element = document.getElementById('form_confirm');
    //proceed_element.classList.toggle('d-none');
    //confirm_element.classList.toggle('d-none');
    toggleOpacity(confirm_element, proceed_element, '0.3s', '0.7s');
}
</script>
{% endif %}
{% if main_problem and assignment.deadline %}
<script src="{% static 'js/countdown.js' %}" type="text/javascript"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
    startCountdown("{{ assignment.deadline.isoformat }}");
});
</script>
{% endif %}
{% endblock javascript %}
