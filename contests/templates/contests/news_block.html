{% load views contests accounts static %}
{% if count_of_news %}
<div class="card mb-3">
    <div class="card-header news-header alert-info">
        <h2 class="mb-0">
            <button class="btn btn-link news-btn-link btn-block text-left d-flex collapsed" type="button" data-toggle="collapse"
                    data-target="#collapseNews" aria-expanded="false" aria-controls="collapseNews">
                Последние новости
{#                <span class="numtus badge-info align-middle ml-auto">{{ count_of_news }}</span>#}
                <span class="badge badge-pill badge-info align-middle ml-auto" style="position: relative; top: 0.2rem;">{{ count_of_news }}</span>
            </button>
        </h2>
    </div>
    <div id="collapseNews" class="collapse">
        <div class="card-body">
        <!-- Актуальное расписание -->
        {% if schedules %}
            <h6 class="mb-2">
                Актуальное расписание
            </h6>
            <div class="list-group mb-3">
            {% for obj in schedules %}
                <a href="{{ obj.get_absolute_url }}" class="list-group-item list-group-item-action d-flex"><span>{{ obj }}</span></a>
            {% endfor %}
            </div>
        {% endif %}
        <!-- Непрочитанные оповещения -->
        {% if notifications %}
            <h6 class="mb-2 d-flex">
                Последние 10 непрочитанных оповещений <a class="text-muted ml-auto" href="{% url 'accounts:notification-list' %}">Смотреть все</a>
            </h6>
            {% now 'Y' as current_year %}
            <div id="notifications" class="list-group mb-3">
            {% for notification in notifications %}
                <li id="{{ notification.id }}" class="list-group-item d-flex {% if not notification.is_read %}bg-light"
                    data-unread=true{% else %}"{% endif %} data-id={{ notification.id }}>
                    <span class="notification-body mr-auto">
                        {% if notification.subject.username %}
                            <a href="{{ notification.subject.account.get_absolute_url }}">{{ notification.subject.account }}</a>
                        {% elif notification.subject %}
                            <a href="{{ notification.subject.get_absolute_url }}"> {{ notification.subject }}</a>
                        {% endif %}
                        {{ notification.action }}
                        {% if notification.object %}
                            <a href="{{ notification.object.get_absolute_url }}" id="object_notif_{{ notification.id }}"> {{ notification.object }}</a>
                        {% endif %}
                        {% if notification.reference %}
                            {% if notification.relation %}
                                {{ notification.relation }}
                            {% endif %}
                            <a href="{{ notification.reference.get_absolute_url }}"> {{ notification.reference }}</a>
                        {% endif %}
                    </span>
                    <span class="text-muted text-right" style="width: 25%;">
                        {% if notification.date_created|date:'Y' == current_year %}
                            {{ notification.date_created|naturaltime_if_lt_week_ago:'j E в H:i' }}
                        {% else %}
                            {{ notification.date_created|naturaltime_if_lt_week_ago:'j E Y г. в H:i' }}
                        {% endif %}
                    </span>
                </li>
            {% endfor %}
            </div>
        {% endif %}
        <!-- Актуальные объявления -->
        {% if announcements %}
            <h6 class="mb-2">
                Актуальные объявления
            </h6>
            <div class="list-group">
            {% for announcement in announcements %}
                <li class="list-group-item d-flex">
                    <span class="notification-body mr-auto">
                        {{ announcement.title }}
                    </span>
                    <span class="text-muted text-right" style="width: 25%;">
                        {{ announcement.date_created|date:'' }}
                    </span>
                </li>
            {% endfor %}
            </div>
        {% endif %}
        </div>
    </div>
</div>
<script type="text/javascript" src="{% static 'js/notifications.js' %}"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
    const watcher = new ReadWatcher("{% url 'accounts:mark-notifications-as-read' %}");
    let notifications_list = document.getElementById('notifications');
    for(let notif_body of notifications_list.children) {
        document.getElementById(`object_notif_${notif_body.id}`).addEventListener('mousedown', function () {
            watcher.set_notification_to_read(notif_body.id);
            setTimeout(watcher.markNotificationsAsRead.bind(watcher), 10);
        });
    }
});
</script>
{% endif %}
