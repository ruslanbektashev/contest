{% load views contests accounts static %}
{% if count_of_news %}
    <div class="card">
            <div class="card-header news-header alert-info" id="course_description">
                <h2 class="mb-0">
                    <button class="btn btn-link news-btn-link btn-block text-left d-flex collapsed" type="button" data-toggle="collapse"
                            data-target="#collapseNews" aria-expanded="false" aria-controls="collapseNews">
                        Последние новости
                        <span class="numtus badge-info align-middle ml-auto">{{ count_of_news }}</span>
                    </button>
                </h2>
            </div>
        <div id="collapseNews" class="collapse" aria-labelledby="course_description">
            <div class="card-body">
                <!-- Актуальное расписание -->
                {% if schedules %}
                    <h6 class="mb-0 my-2">
                        Актуальное расписание
                    </h6>
                    {% for obj in schedules %}
                        <a href="{{ obj.get_absolute_url }}" class="list-group-item list-group-item-action d-flex"><span>{{ obj }}</span>{% if obj.is_current %} <span class="numtus badge-primary align-middle ml-auto">На текущую неделю</span>{% elif obj.is_upcoming %} <span class="numtus badge-success align-middle ml-auto">На грядущую неделю</span>{% endif %}</a>
                    {% endfor %}
                    <br>
                {% endif %}
                <!-- Непрочитанные оповещения -->
                {% if notifications %}
                    <h6 class="mb-0 my-2">
                        Последние непрочитанные оповещения
                    </h6>
                    {% now 'Y' as current_year %}
                    {% for notification in notifications %}
                        <li id="{{ notification.id }}" class="notification-list-item list-group-item d-flex {% if not notification.is_read %}bg-light"
                            data-unread=true{% else %}"{% endif %} data-id={{ notification.id }}>
                            <span class="notification-body mr-auto">
                                {% if notification.subject.username %}
                                    <a href="{{ notification.subject.account.get_absolute_url }}">{{ notification.subject.account }}</a>
                                {% elif notification.subject %}
                                    <a href="{{ notification.subject.get_absolute_url }}"> {{ notification.subject }}</a>
                                {% endif %}
                                {{ notification.action }}
                                {% if notification.object %}
                                    <a href="{{ notification.object.get_absolute_url }}" id="object_notif_{{ notification.id }}"> {{ notification.object }}</a>
                                {% endif %}
                                {% if notification.reference %}
                                    {% if notification.relation %}
                                        {{ notification.relation }}
                                    {% endif %}
                                    <a href="{{ notification.reference.get_absolute_url }}"> {{ notification.reference }}</a>
                                {% endif %}
                            </span>
                            <span class="text-muted text-right" style="width: 25%;">
                                {% if notification.date_created|date:'Y' == current_year %}
                                    {{ notification.date_created|naturaltime_if_lt_week_ago:'j E в H:i' }}
                                {% else %}
                                    {{ notification.date_created|naturaltime_if_lt_week_ago:'j E Y г. в H:i' }}
                                {% endif %}
                            </span>
                        </li>
                    {% endfor %}
                    <span class="my-3">Показаны последние 10 непрочитанных оповещений. <a href="{% url 'accounts:notification-list' %}">Посмотреть все</a></span>
                    <br>
                    <br>
                {% endif %}
                <!-- Актуальные объявления -->
                {% if announcements %}
                    <h6 class="mb-0 my-2">
                        Актуальные объявления
                    </h6>
                    {% for announcement in announcements %}
                        <li class="notification-list-item list-group-item d-flex">
                            <span class="notification-body mr-auto">
                                {{ announcement.title }}
                            </span>
                            <span class="text-muted text-right" style="width: 25%;">
                                {{ announcement.date_created|date:'' }}
                            </span>
                        </li>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
{% endif %}
<script type="text/javascript" src="{% static 'js/notifications.js' %}"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
    const watcher = new ReadWatcher("{% url 'accounts:mark-notifications-as-read' %}");
    let notifications_list = document.getElementById('notifications');
    for(let notif_body of notifications_list.children) {
        document.getElementById(`object_notif_${notif_body.id}`).addEventListener('mousedown', function () {
            watcher.set_notification_to_read(notif_body.id);
            setTimeout(watcher.markNotificationsAsRead.bind(watcher), 10);
        });
    }
});
</script>
